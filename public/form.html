<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Reservar cita</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="preconnect" href="https://fonts.gstatic.com">
<style>
  body{font-family:Arial,Helvetica,sans-serif;margin:0;padding:2rem;background:#f4f6fa}
  .card{max-width:480px;margin:auto;background:#fff;padding:2rem;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.1)}
  h2{margin-top:0;color:#1a1a1a}
  label{display:block;margin:12px 0 4px;font-weight:600}
  input,select,button{width:100%;padding:.6rem .8rem;border:1px solid #ccc;border-radius:6px;font-size:1rem}
  button{background:#0063f7;color:#fff;border:none;margin-top:1.2rem;cursor:pointer}
  #msg{margin-top:1rem;font-size:.9rem}
</style>
</head>
<body>
<div class="card">
  <h2 id="negocio">Reservar cita</h2>

  <label>Nombre</label>
  <input id="name" />

  <label>Email</label>
  <input id="email" type="email" />

  <label>Teléfono</label>
  <input id="phone" />

  <label>Fecha</label>
  <input id="date" type="date" />

  <label>Hora</label>
  <select id="time"><option value="">Selecciona primero la fecha…</option></select>

  <button id="btn">Reservar</button>
  <div id="msg"></div>
</div>

<script>
// ========= utilidades pequeñas =============
const $ = sel => document.querySelector(sel);
const qs = new URLSearchParams(location.search);
const slug = qs.get('slug');          // ?slug=peluqueria-jenny

if(!slug){ $('#msg').textContent = 'Sin slug'; $('#btn').disabled = true; }

const api = 'https://agenda-connect.onrender.com';

// ========= cargar config y bloquear días =========
let cfg = null;
(async () => {
  const r = await fetch(api + `/api/config/${slug}`);
  cfg = await r.json();
  if(!r.ok || !cfg.nombre){ $('#msg').textContent = 'Negocio no encontrado'; return; }

  $('#negocio').textContent = `Reservar en ${cfg.nombre}`;

  // bloquear días no laborables
  const dias = cfg.work_days || [];              // [1,2,3,4,5]
  $('#date').addEventListener('change', e=>{
    const day = new Date(e.target.value).getDay();
    if(!dias.includes(day)){
      $('#msg').textContent = '⛔ El negocio no abre ese día';
      $('#time').innerHTML  = `<option></option>`;
      return;
    }
    $('#msg').textContent = '';
    cargarHoras(e.target.value);
  });
})();

// ========= generar horarios y consultar disponibilidad =========
async function cargarHoras(fechaStr){
  const horarios = [];
  const inicio = new Date(); inicio.setHours(+cfg.start_hour,0,0,0);
  const fin    = new Date(); fin.setHours(+cfg.end_hour ,0,0,0);
  while(inicio < fin){
    const HH = inicio.getHours().toString().padStart(2,'0');
    const MM = inicio.getMinutes().toString().padStart(2,'0');
    horarios.push(`${HH}:${MM}`);
    inicio.setMinutes(inicio.getMinutes()+ (cfg.duration_minutes||30));
  }

  $('#time').innerHTML = '<option>Cargando…</option>';

  const libres = [];
  for(const h of horarios){
    const res = await fetch(`${api}/api/availability/${slug}?date=${fechaStr}&time=${h}`);
    const {available} = await res.json();
    if(available) libres.push(h);
  }

  $('#time').innerHTML = libres.length
    ? '<option></option>' + libres.map(h=>`<option value="${h}">${h}</option>`).join('')
    : '<option>No hay horas libres</option>';
}

// ========= crear cita =========
$('#btn').onclick = async ()=>{
  const name = $('#name').value.trim();
  const email= $('#email').value.trim();
  const phone= $('#phone').value.trim();
  const date = $('#date').value;
  const time = $('#time').value;
  if(!name||!email||!date||!time){ $('#msg').textContent = 'Completa todos los campos'; return; }

  $('#btn').disabled = true; $('#msg').textContent = 'Enviando…';

  const res = await fetch(`${api}/api/citas/${slug}`,{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({name,email,phone,date,time})
  });
  const json = await res.json();
  $('#btn').disabled = false;

  if(res.ok){
    $('#msg').textContent = '✅ Cita creada. Revisa tu correo.';
    $('#btn').style.display = 'none';
  }else{
    $('#msg').textContent = '⛔ ' + (json.error||'No se pudo crear');
  }
};
</script>
</body>
</html>
