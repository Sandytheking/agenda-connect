<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Reservar cita</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:0;padding:2rem;background:#f4f6fa}
    .card{max-width:480px;margin:auto;background:#fff;padding:2rem;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.1)}
    h2{margin-top:0;color:#1a1a1a}
    label{display:block;margin:12px 0 4px;font-weight:600}
    input,select,button{width:100%;padding:.6rem .8rem;border:1px solid #ccc;border-radius:6px;font-size:1rem}
    button{background:#0063f7;color:#fff;border:none;margin-top:1.2rem;cursor:pointer}
    #msg{margin-top:1rem;font-size:.9rem}
  </style>
</head>
<body>
<div class="card">
  <h2 id="negocio">Reservar cita</h2>

  <label>Nombre</label>
  <input id="name" />

  <label>Email</label>
  <input id="email" type="email" />

  <label>Tel√©fono</label>
  <input id="phone" />

  <label>Fecha</label>
  <input id="date" type="date" />

  <label>Hora</label>
  <select id="time"><option value="">Selecciona primero la fecha‚Ä¶</option></select>

  <button id="btn">Reservar</button>
  <div id="msg"></div>
</div>

<script>
const $   = s => document.querySelector(s);
const api = 'https://agenda-connect.onrender.com';

// Obtener slug desde URL
/* 1Ô∏è‚É£  Obtener slug de la query ?slug=... */
const params = new URLSearchParams(location.search);
const slug   = params.get('slug');        // ej. "ramon-peluqueria"

if (!slug) {
  $('#msg').textContent = 'Slug no especificado';
  $('#btn').disabled = true;
}

if (!slug) {
  $('#msg').textContent = '‚ùå Falta slug';
  $('#btn').disabled = true;
} else {
  $('#msg').textContent = üîé Buscando ¬´${slug}¬ª‚Ä¶;   // ‚Üê ver√°s qu√© valor lee
}


let cfg = null;

(async () => {
  try {
    const res = await fetch(${api}/api/public-config/${slug});
    cfg = await res.json();
    console.log('üõ† CFG:', cfg); // ‚Üê Agrega esta l√≠nea
    if (!res.ok || !cfg.nombre) throw new Error(cfg.error || 'Negocio no encontrado');

    $('#negocio').textContent = Reservar en ${cfg.nombre};

    // Bloquear fechas pasadas
    const hoy = new Date(); hoy.setHours(0,0,0,0);
    $('#date').min = hoy.toISOString().split('T')[0];

// ‚úÖ Convertir nombres de d√≠as a n√∫meros (0 = Domingo, 1 = Lunes, ...)
  const diasLaborables = cfg.work_days || [];
console.log("üì¶ work_days recibidos:", cfg.work_days);

$('#date').addEventListener('change', e => {
  if (!e.target.value) return;                 // nada seleccionado

  // Construimos la fecha local (sin problemas de zona horaria)
  const [y, m, d] = e.target.value.split('-').map(Number);
  const fecha = new Date(y, m - 1, d, 12, 0, 0); // 12‚ÄØh local para evitar desfases
  const dia   = fecha.getDay();                 // 0‚Äë6 (Dom‚ÄëS√°b)

  console.log('üëâ D√≠a elegido =', dia, '‚Ä¢ Laborables =', diasLaborables);

  if (!diasLaborables.includes(dia)) {
    $('#msg').textContent = '‚õî‚ÄØEl negocio no abre ese d√≠a';
    $('#time').innerHTML  = '<option></option>';
    return;
  }

  $('#msg').textContent = '';
  cargarHorasDisponibles(e.target.value);       // 'YYYY‚ÄëMM‚ÄëDD'
});


  } catch (err) {
    console.error(err);
    $('#msg').textContent = err.message;
    $('#btn').disabled = true;
  }
})();

function generarSlots() {
  const paso = Number(cfg.duration_minutes || 30);
  const cur = new Date();
  cur.setHours(+cfg.start_hour, 0, 0, 0);
  const fin = new Date();
  fin.setHours(+cfg.end_hour, 0, 0, 0);

let { start_hour, end_hour } = cfg;
start_hour = Number(start_hour.split(':')[0] || 0);
end_hour   = Number(end_hour  .split(':')[0] || 0);

if (end_hour <= start_hour) {
  console.warn('‚ö†Ô∏è end_hour <= start_hour, usando +12‚ÄØh por defecto');
  end_hour += 12;          // o simplemente retorna []
}


  const out = [];
  while (cur < fin) {
    const HH = cur.getHours().toString().padStart(2, '0');
    const MM = cur.getMinutes().toString().padStart(2, '0');
    out.push(${HH}:${MM});
    cur.setMinutes(cur.getMinutes() + paso);
  }
  return out;
}

async function cargarHorasDisponibles(fechaISO){
  $('#time').innerHTML = '<option>Cargando‚Ä¶</option>';
  $('#time').disabled  = true;

  const libres = [];
  for (const h of generarSlots()){
    const r   = await fetch(${api}/api/availability/${slug}?date=${fechaISO}&time=${h});
    const { available } = await r.json();
    if (available) libres.push(h);
  }

  $('#time').innerHTML = libres.length
        ? <option value=""></option>${libres.map(h=><option value="${h}">${h}</option>).join('')}
        : '<option>No hay horas libres</option>';
  $('#time').disabled = !libres.length;
}

$('#btn').onclick = async () => {
  const name  = $('#name').value.trim();
  const email = $('#email').value.trim();
  const phone = $('#phone').value.trim();
  const date  = $('#date').value;
  const time  = $('#time').value;

  if (!name || !email || !date || !time) {
    $('#msg').textContent = 'Completa todos los campos';
    return;
  }

  $('#btn').disabled = true;
  $('#msg').textContent = 'Enviando‚Ä¶';

  const res = await fetch(${api}/api/citas/${slug}, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name, email, phone, date, time })
  });


  const json = await res.json();
  $('#btn').disabled = false;

  if (res.ok) {
    $('#msg').textContent = '‚úÖ Cita creada. Revisa tu correo.';
    $('#btn').style.display = 'none';
  } else {
    $('#msg').textContent = '‚õî ' + (json.error || 'No se pudo crear la cita');
  }
};
</script>
</body>
</html>

// üìÅ routes/publicConfig.js
import express from 'express';
import { createClient } from '@supabase/supabase-js';

const router = express.Router();

const supabase = createClient(
  process.env.SUPABASE_URL,
  process.env.SUPABASE_SERVICE_ROLE_KEY
);

router.get('/api/public-config/:slug', async (req, res) => {
  const { slug } = req.params;
  console.log('[public-config] slug recibido =>', slug);

  try {
    const { data, error } = await supabase
      .from('clients')
      .select(
        nombre,
        work_days,
        start_hour,
        end_hour,
        duration_minutes,
        max_per_day,
        max_per_hour,
        timezone
      )
      .eq('slug', slug)
      .single();

    if (error || !data) {
      console.error('‚ùå Error Supabase:', error);
      return res.status(404).json({ error: 'Negocio no encontrado' });
    }

    // ‚úÖ Valores que van al frontend (sin convertir horas)
    data.duration_minutes = Number(data.duration_minutes || 30);
    data.max_per_day      = Number(data.max_per_day || 5);
    data.max_per_hour     = Number(data.max_per_hour || 1);
    data.start_hour       = data.start_hour || "08:00";
    data.end_hour         = data.end_hour   || "17:00";

    // ‚úÖ Convertir work_days a [1,2,3,...]
    const dias = {
  Sunday: 0, Monday: 1, Tuesday: 2,
  Wednesday: 3, Thursday: 4,
  Friday: 5, Saturday: 6
};

// DEBUG: muestra los d√≠as antes de convertir
console.log('üü° work_days original en texto:', data.work_days);

// Convierte solo d√≠as v√°lidos
data.work_days = (data.work_days || [])
  .filter(d => dias[d] !== undefined)
  .map(d => dias[d]);

console.log('‚úÖ work_days convertidos a n√∫meros:', data.work_days);

    // Log para confirmar
    console.log("üîÅ work_days enviados:", data.work_days);

    res.json(data);
  } catch (e) {
    console.error('‚ùå /api/public-config error:', e);
    res.status(500).json({ error: 'Error interno' });
  }
});

export default router;